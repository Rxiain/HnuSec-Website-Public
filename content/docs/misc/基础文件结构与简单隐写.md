

# 基础文件结构与简单隐写

## 1. 常见文件格式结构解析

### 1.1 图像文件格式

#### JPG/JPEG

JPG文件由多个功能段（Segments）按严格顺序组成，每个段以 `0xFF`+标记码 开头，后接长度与内容。

**核心结构：**

```markdown
SOI + [APPn] + DQT + SOF0 + DHT + [DRI] + SOS + 压缩数据 + EOI
```

**关键段详解：**

- **SOI (Start of Image)**：文件起始标记 `0xFFD8`
- **APPn (Application Segments)**：`0xFFE0~0xFFEF`，存储EXIF、ICC配置等元数据
- **DQT (Define Quantization Table)**：`0xFFDB`，定义量化表，控制压缩质量
- **SOF0 (Start of Frame)**：`0xFFC0`，定义图像宽、高、色彩分量数
- **DHT (Define Huffman Table)**：`0xFFC4`，定义哈夫曼编码表
- **SOS (Start of Scan)**：`0xFFDA`，标志压缩图像数据开始
- **EOI (End of Image)**：`0xFFD9`，文件结束标记，其后数据不被解码器读取

#### PNG

PNG文件由固定签名和多个数据块组成。

**文件签名（8字节）：**

```markdown
89 50 4E 47 0D 0A 1A 0A  (ASCII: .PNG....)
```

**数据块结构：**

```markdown
长度(4B) + 块类型(4B) + 块数据(长度字段值) + CRC(4B)
```

**关键数据块：**

- **IHDR** (13字节)：宽(4B)、高(4B)、位深(1B)、色彩类型(1B)、压缩/过滤/交错方法(各1B)
- **PLTE**：调色板数据，索引颜色图像必需
- **IDAT**：存储压缩后的图像数据，可分割为多个块
- **tEXt/zTXt/iTXt**：存储可显示文本、压缩文本或国际化文本
- **IEND**：文件结束，数据为空

#### BMP

Windows位图，结构简单无压缩。

**文件结构：**

1. **位图文件头 (14字节)**
   - 标识符：`0x4D42` ("BM")
   - 文件大小(4B)
   - 保留字段(4B)
   - 像素数据偏移量(4B)
2. **位图信息头 (40字节)**
   - 本结构大小(4B)
   - 图像宽、高(各4B，有符号)
   - 颜色平面数(2B，始终为1)
   - 每像素位数(2B)：1、4、8、16、24、32
   - 压缩方式(4B)：0(无)、1(8位RLE)、2(4位RLE)
   - 图像大小(4B)
   - 水平/垂直分辨率(各4B)
   - 调色板颜色数(4B)
   - 重要颜色数(4B)
3. **调色板**（可选，仅限索引颜色）
4. **像素数据**：从图像左下角开始，从左到右、从下到上存储

### 1.2 音频文件格式

#### WAV

基于RIFF容器格式的未压缩音频。

**文件结构：**

```markdown
RIFF块(标识"WAVE") + fmt子块 + data子块 + [其他可选子块]
```

**关键块详解：**

- **RIFF块头**：`"RIFF"`(4B) + 文件大小(4B) + `"WAVE"`(4B)
- **fmt子块**：`"fmt "`(4B) + 块大小(4B) + 音频格式(2B，1=PCM) + 声道数(2B) + 采样率(4B) + 字节率(4B) + 块对齐(2B) + 位深度(2B)
- **data子块**：`"data"`(4B) + 数据大小(4B) + 原始PCM数据

#### MP3

基于帧的压缩音频格式，可包含ID3元数据标签。

**ID3v2标签**（文件开头）：

- 标识：`"ID3"`(3B)
- 版本(2B)
- 标志(1B)
- 标签大小(4B，同步安全编码)
- 多个帧（标题、艺术家、专辑等）

**MP3帧结构**：

- 帧头(4B)：同步字(11位)+版本+层+CRC保护+比特率索引+采样率索引+填充+私有+声道模式等
- 可选CRC(2B)
- 音频数据（主数据）
- 可选辅助数据

### 1.3 压缩文件格式

#### ZIP

基于PKZIP格式的归档文件。

**整体结构：**

```markdown
[本地文件头1 + 文件数据1 + 数据描述符1] + ... + 中央目录 + 中央目录结束记录
```

**关键部分详解：**

- **本地文件头**：签名(`0x04034b50`)+版本+标志+压缩方法+修改时间/日期+CRC32+压缩/未压缩大小+文件名长+额外字段长，后跟文件名和额外字段
- **文件数据**：压缩后的实际内容
- **中央目录文件头**：签名(`0x02014b50`)+创建/修改版本+本地头中信息+文件注释长+磁盘号开始+内部/外部属性+相对偏移，后跟文件名、额外字段、注释
- **中央目录结束记录**：签名(`0x06054b50`)+磁盘号+中央目录起始磁盘+本磁盘目录数+总目录数+中央目录大小+中央目录偏移量+ZIP注释长

#### RAR

RAR压缩文件格式（以RAR5为例）。

**基本结构：**

```markdown
RAR签名(8B) + 压缩包头部 + [文件头1 + 文件数据1] + ... + 结束标记
```

**关键部分详解：**

- **RAR5签名**：`RAR\x1A\x07\x01\x00` (8字节)
- **压缩包头部**：头部大小+标志+额外区域大小（可选）
- **文件头部**：头部大小+类型+标志+额外区域大小+数据大小+属性等，后跟额外区域（可选）和文件名
- **文件数据**：压缩或存储的内容
- **结束标记**：头部大小(`0x03 0x00`)+类型(`0x05`)

## 2. 常见编码类型

| 编码类型       | 说明                                | 特征                              | 示例                             |
| :------------- | :---------------------------------- | :-------------------------------- | :------------------------------- |
| **Base64**     | 将3字节二进制数据编码为4个ASCII字符 | `A-Z a-z 0-9 + /`，常以`=`填充    | `aGVsbG8=` → `hello`             |
| **Base32**     | 将5字节编码为8个字符                | `A-Z 2-7`，`=`填充                | `NBSWY3DP` → `hello`             |
| **Base16/Hex** | 十六进制表示                        | `0-9 A-F`，每字节两字符           | `68656C6C6F` → `hello`           |
| **ASCII**      | 美国信息交换标准码                  | 0-127的整数值                     | `104 101 108 108 111` → `hello`  |
| **Binary**     | 二进制表示                          | 每8位一组，0和1组成               | `01101000 01100101...` → `hello` |
| **ROT13**      | 字母移位13位                        | 仅字母变换，自逆                  | `uryyb` → `hello`                |
| **ROT47**      | ASCII 33-126范围移位47位            | 数字、字母、符号都变化            | `96==@` → `hello`                |
| **URL编码**    | 百分号编码                          | `%`后跟两位十六进制               | `%68%65%6C%6C%6F` → `hello`      |
| **HTML实体**   | HTML特殊字符编码                    | `&#`后跟十进制或`&#x`后跟十六进制 | `hello` → `hello`                |
| **Morse**      | 摩斯电码                            | 点(.)划(-)分隔，字符间`/`或空格   | `.... . .-.. .-.. ---` → `hello` |

## 3. 图像、音频等文件隐写

### 3.1 图像隐写技术

#### 空间域隐写

- **LSB（最低有效位）隐写**：修改像素RGB值的最低1-n位，对BMP、PNG等无损格式有效
- **调色板修改**：修改索引颜色图像的调色板项顺序或颜色值
- **像素值调整**：通过特定算法微调像素值，保持视觉一致性

#### 文件结构隐写

- **JPEG APPn/COM段插入**：在`0xFFE0~0xFFEF`或`0xFFFE`段添加额外数据
- **PNG辅助块隐写**：使用tEXt、zTXt、iTXt块存储隐藏信息
- **EOF后追加**：在JPEG的`0xFFD9`或PNG的IEND后追加数据
- **多文件捆绑**：将文件追加到图像后，利用文件头差异分离

#### 变换域隐写

- **DCT系数隐写（JPEG）**：修改量化后的离散余弦变换系数值
- **DWT隐写**：基于小波变换域的系数修改

### 3.2 音频隐写技术

#### 时域隐写

- **LSB音频隐写**：修改PCM采样值的低有效位
- **回声隐藏**：添加多个具有微小延迟和衰减的回声，在延迟参数中编码信息
- **相位编码**：用代表秘密信息的参考相位替换原始相位

#### 频域隐写

- **频谱隐藏**：在音频频谱的特定频段嵌入信息（如SSTV将图像编码为声音）
- **扩频隐写**：使用扩频技术将信息分散到宽频带中
- **量化索引调制**：通过量化参数传递信息

### 3.3 其他文件隐写技术

- **文本格式隐写**：利用Word、PDF等格式的元数据、注释、修订记录
- **空白字符隐写**：在文本中使用空格、制表符、零宽字符（U+200B, U+200C等）编码信息
- **格式微调**：轻微调整字体大小、颜色、行距等传递信息

## 4. 压缩包攻击技术

### 4.1 爆破攻击

#### 字典攻击

使用常见密码词典尝试解压，针对弱密码有效。

**常用字典：**

- rockyou.txt（经典泄露密码集）
- 弱密码词典（123456, password, admin等）
- 基于目标的定制词典（姓名、生日、组合等）

#### 掩码攻击

已知密码部分结构时使用，如：已知前3位是"ABC"，后4位是数字。

**常见掩码模式：**

- `?l`：小写字母
- `?u`：大写字母
- `?d`：数字
- `?s`：特殊字符
- `?a`：所有字符

#### 暴力破解

遍历所有可能的字符组合，复杂度随密码长度指数增长。

**适用场景：**

- 极短密码（<=6位）
- 已知字符集范围小

### 4.2 明文攻击

#### 原理与条件

已知压缩包中某个未加密文件的完整内容，或拥有某个文件的十二字节明文及其偏移量，其中至少八字节连续，利用加密算法特性恢复密钥。

**必要条件：**

1. 拥有加密压缩包
2. 知道包中某个文件加密前的原始内容/部分明文
3. 该文件在压缩包中未经修改

4. 加密算法为ZipCrypto
