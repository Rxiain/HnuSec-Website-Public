## 一、 流量分析概论
流量分析是指通过捕获网络数据包，分析其协议构成、数据载荷，从而发现隐藏信息（如 Flag、密码、后门指令等）的过程。

常用工具：

+ Wireshark：图形化界面分析利器。
+ Tshark：命令行版本，适合处理超大流量包。

常见文件格式：**.pcap**,** .pcapng**。

**.pcap（Packet Capture）**

+ 是较早的抓包文件格式，最初由 libpcap（Linux/Unix）和 WinPcap（Windows）库定义。
+ 格式简单，但功能有限，属于“传统”格式。

**.pcapng（PCAP Next Generation）**

+ 是 .pcap 的现代化扩展版本，由 Wireshark 团队主导设计，现已成为 IETF 官方标准（RFC 7932）。
+ 旨在解决 .pcap 的诸多限制，支持更丰富的元数据和多接口捕获。

## 二、 Wireshark 常见操作
在 CTF 中，盲目翻阅成千上万个包是不可行的，必须学会过滤。

### 过滤器语法 (Display Filters)
+ 协议过滤：直接输入** http, icmp, tcp, udp, dns**。
+ IP 过滤：**ip.addr == 192.168.1.1 或 ip.src == 10.0.0.2**。
+ 端口过滤：**tcp.port == 80。**
+ 逻辑组合：**and, or, ! (非)。**
+ 如：**http && ip.addr == 192.168.1.5**

### 流汇聚 (Follow Stream)
右键点击数据包 -> Follow -> TCP/HTTP。 这是最常用的功能，可以将散乱的数据包拼接成完整的对话内容，直接查看传输的明文数据。

## 三、 常见协议分析要点
CTF 题目通常集中在以下几种协议：

### HTTP 协议 (Web 流量)
特征：明文传输。

重点：查看 POST 请求的数据、上传的文件、返回的 HTML 源码。

技巧：使用 http.request.method == "POST" 寻找post提交记录,往往重要信息会在post上传输。

导出对象：File -> Export Objects -> HTTP，可以直接提取流量包中传输的所有图片、PHP 脚本或 ZIP 包。

### ICMP 协议 (Ping 隧道)
特征：正常的 Ping 包 Data 部分应为固定长度的重复字符。

隐写点：Flag 可能被拆分后按顺序藏在每个 ICMP 包的 Data 字段中。

### DNS 协议 (域名解析)
特征：查询记录。

隐写点：利用 DNS 隧道传输数据。观察查询的二级域名，如果是长串的 Base64 编码，通常就是隐藏的信息。

### FTP/Telnet (管理协议)
特征：明文传输账号密码。

重点：Follow TCP Stream，直接找 USER 和 PASS 关键词。



## 四、 进阶实战技巧
### 流量包中的隐写提取
如果流量包中包含文件传输（如图片、压缩包），Wireshark 无法直接导出时：

使用Binwalk/Foremost工具来自动分离其中的二进制文件。

### 数据处理与脚本化
当 Flag 被分散在成百上千个包中时，手动复制不现实。

Tshark 提取特定列： tshark -r challenge.pcap -Y "icmp" -T fields -e data.data >output.txt

（提取所有 ICMP 包中的 Data 内容并且重定向到output.txt，方便后续用python脚本分析）



## 五、USB流量介绍
USB流量指的是USB设备接口的流量，攻击者能够通过监听usb接口流量获取键盘敲击键、鼠标移动与点击、存储设备的铭文传输通信、USB无线网卡网络传输内容等等。在CTF中，USB流量分析主要以**键盘**和鼠标流量为主。

```plain
常用命令：
tshark -r  123.pcapng  -T fields -e usb.capdata > out.txt   #usb流量

tshark -r  draobyek.pcapng  -T fields -e usbhid.data  > out.txt   #键盘流量

tshark -r 1.pcapng  -T json >test.json    #提取所有字段值，自己需要什么找什么
```

### 键盘流量： 
Keyboard流量数据标准长度为<u>八个字节</u>，键盘流量的第一个字节**代表修饰键状态**：

每一位代表一个修饰键是否按下：

**bit0**：左Ctrl键，按下为1。

**bit1**：左Shift键，按下为1。

**bit2**：左Alt键，按下为1。

键盘流量的第二个字节<font style="color:rgb(51, 51, 51);background-color:rgb(248, 248, 248);">没什么含义，为保留位</font>

重点为第三个字节，键盘击键信息集中在第三个字节中

	**00**00_**<font style="color:#DF2A3F;">04</font>**_00**00**00**00**00中的敲击信息为0x04，对应a

	**00**00_**<font style="color:#DF2A3F;">05</font>**_00**00**00**00**00中的敲击信息为0x06，对应b

	**00**00_**<font style="color:#DF2A3F;">06</font>**_00**00**00**00**00中的敲击信息为0x06，对应c

	**00**00_**<font style="color:#DF2A3F;">1E</font>**_00**00**00**00**00中的敲击信息为0x1e，对应1 

<!-- 这是一张图片，ocr 内容为：应用显示过滤器<CTRL-/> PROTOLENGTLINFO NO. TIME SOURCE DESTINATION IN 72URB INTERRUPT HOST 1.10.1 USB 19 1.612183 IN INTERRUPT 1.10.1 64 URB HOST 201.612235 USB 72 URB 1.10.1 HOST IN INTERRUPT 21 1.620184 USB INTERRUPT IN HOST 22 1.620236 1.10.1 64 URB USB 72 URB INTERRUPT IN 1.10.1 23 1.628182 HOST USB HOST 64 URB INTERRUPT IN 1.10.1 241.628233 USB 72 BYTES ON WIRE (576 BITS), 72 BYTES CAPTURED (576 BITS) 21: FRAME USBURB LEFTOVER CAPTURE DATA: 00000600000000000 81 F9 01 88 FF FF 43 81 36 01 01 0000 00 OA 2D 00 CO 4Q 3427510000000 0010 33 0200 81 00 00 000 A1 0020 000 0000008000000 00000 08 00 00 00 0030 02 00000 0000000 000000000000 0402 00 0006000000000 0040 00 -->
![](https://cdn.nlark.com/yuque/0/2026/png/49967934/1769153246784-dd610712-c97d-4c25-aeac-eff5a018c81f.png)

完整的映射表：

```plain
hid_keymap = {
    "04": "a", "05": "b", "06": "c", "07": "d", "08": "e", "09": "f", "0a": "g", "0b": "h", "0c": "i",
    "0d": "j", "0e": "k", "0f": "l", "10": "m", "11": "n", "12": "o", "13": "p", "14": "q", "15": "r",
    "16": "s", "17": "t", "18": "u", "19": "v", "1a": "w", "1b": "x", "1c": "y", "1d": "z", "1e": "1",
    "1f": "2", "20": "3", "21": "4", "22": "5", "23": "6", "24": "7", "25": "8", "26": "9", "27": "0",
    "28": "<RET>", "29": "<ESC>", "2a": "<DEL>", "2b": "\t", "2c": "<SPACE>", "2d": "-", "2e": "=",
    "2f": "[", "30": "]", "31": "\\", "32": "<NON>", "33": ";", "34": "'", "35": "<GA>", "36": ",",
    "37": ".", "38": "/", "39": "<CAP>", "3a": "<F1>", "3b": "<F2>", "3c": "<F3>", "3d": "<F4>",
    "3e": "<F5>", "3f": "<F6>", "40": "<F7>", "41": "<F8>", "42": "<F9>", "43": "<F10>", "44": "<F11>",
    "45": "<F12>", "46": "<PRTSC>", "47": "<SCRLK>", "48": "<PAUSE>", "49": "<INS>", "4a": "<HOME>",
    "4b": "<PGUP>", "4c": "<DEL_FWD>", "4d": "<END>", "4e": "<PGDN>", "4f": "<RIGHT>", "50": "<LEFT>",
    "51": "<DOWN>", "52": "<UP>", "53": "<NUMLOCK>", "54": "/", "55": "*", "56": "-", "57": "+",
    "58": "<ENTER>", "59": "1", "5a": "2", "5b": "3", "5c": "4", "5d": "5", "5e": "6", "5f": "7",
    "60": "8", "61": "9", "62": "0", "63": ".", "64": "<NONUS_BACK>", "65": "<APP>", "66": "<POWER>",
    "67": "=", "68": "<F13>", "69": "<F14>", "6a": "<F15>", "6b": "<F16>", "6c": "<F17>", "6d": "<F18>",
    "6e": "<F19>", "6f": "<F20>", "70": "<F21>", "71": "<F22>", "72": "<F23>", "73": "<F24>"
}
```

---

### 鼠标流量
鼠标流量数据长度一般为<u>四个字节</u>。其中键盘击键信息集中在第二、三个字节中

 00**0020**00

+  其中第一个字节代表按键，当取0x00时，代表没有按键、为0x01时，代表按左键，为0x02时，代表当前按键为右键。
+  第二个字节可以看成是一个signed byte类型，其最高位为符号位，当这个值为正时，代表鼠标水平右移多少像素，为负时，代表水平左移多少像素。
+  第三个字节与第二字节类似，代表垂直上下移动的偏移。

<font style="color:rgb(51, 51, 51);"> 如图，数据信息为0x00002000，表示鼠标垂直向上移动0x20个单位</font>

<!-- 这是一张图片，ocr 内容为：PROTOLENGTLINFO DESTINATION TIME SOURCE NO. 10 1.030704 IN USB 2.3.1 HOST 31URB INTERRUPT 2.3.1 IN HOST USB 11 1.030704 31URB INTERRUPT 2.3.1 IN HOST 12 1.051867 USB 31 URB INTERRUPT 2.3.1 IN HOST 131.052340 USB INTERRUPT 31 URB 2.3.1 HOST IN 31 URB 141.052340 USB INTERRUPT 2.3.1 HOST 15 1.068194 USB 31URB IN INTERRUPT 2.3.1 HOST USB 161.083866 INTERRUPT 31 URB IN 2.3.1 INTERRUPT USB HOST 171.083866 IN 31 URB 2.3.1 IN 18 1.099498 USB HOST 31 URB INTERRUPT 2.3.1 IN 31 URB INTERRUPT 19 USB 1.099498 HOST FRAME 18: 31 BYTES ON WIRE (248 BITS), 31 BYTES CAPTURED (248 BITS) USBURB LEFTOVER CAPTURE DATA: 00002000 -->
![](https://cdn.nlark.com/yuque/0/2026/png/49967934/1769153258077-df7231fe-bd80-48cb-897c-9e21ab9d67eb.png)

## 六、 流量分析常用流程
当你拿到一个流量包时：

**分级统计**：Statistics -> Protocol Hierarchy（查看哪个协议占比最大 或者 哪个协议占比最小，有一个大概的了解）。

**导出 HTTP 对象**：看是否有可疑的 flag.php, secret.zip。

**关键词搜索**：Ctrl+F 搜索 "flag", "key", "password", "ctf"等关键词

**检查未知长字符串**：发现 Base64 或 Hex 字符串立即解码。





